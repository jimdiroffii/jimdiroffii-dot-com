---
// Complete 3-way theme toggle component
---

<button
	id="theme-toggle"
	type="button"
	class="relative inline-flex items-center justify-center p-2 rounded-lg border border-black/10 dark:border-white/20 bg-white dark:bg-black hover:bg-black/5 dark:hover:bg-white/10 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-current focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-black"
	aria-label="Toggle theme"
	aria-describedby="theme-tooltip"
>
	<!-- Light mode icon -->
	<svg
		id="theme-icon-light"
		class="w-5 h-5 text-current"
		fill="currentColor"
		viewBox="0 0 20 20"
		aria-hidden="true"
	>
		<path
			fill-rule="evenodd"
			d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
			clip-rule="evenodd"></path>
	</svg>

	<!-- Dark mode icon -->
	<svg
		id="theme-icon-dark"
		class="w-5 h-5 text-current"
		fill="currentColor"
		viewBox="0 0 20 20"
		aria-hidden="true"
	>
		<path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
		></path>
	</svg>

	<!-- System mode icon -->
	<svg
		id="theme-icon-system"
		class="w-5 h-5 text-current"
		fill="none"
		stroke="currentColor"
		viewBox="0 0 24 24"
		aria-hidden="true"
	>
		<path
			stroke-linecap="round"
			stroke-linejoin="round"
			stroke-width="2"
			d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
		></path>
	</svg>

	<span id="theme-label" class="ml-2 text-sm font-medium"> System </span>
</button>

<!-- Tooltip for accessibility -->
<div id="theme-tooltip" class="sr-only" role="tooltip">
	<span id="tooltip-text">Switch between light, dark, and system theme</span>
</div>

<style>
	/* Hide all icons by default */
	#theme-icon-light,
	#theme-icon-dark,
	#theme-icon-system {
		display: none;
	}

	/* Show appropriate icon based on data attribute */
	[data-theme="light"] #theme-icon-light,
	[data-theme="dark"] #theme-icon-dark,
	[data-theme="system"] #theme-icon-system {
		display: block;
	}

	/* Smooth transitions */
	#theme-toggle {
		transition: all 0.2s ease;
	}

	#theme-toggle:hover {
		transform: translateY(-1px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	}

	:global(.dark) #theme-toggle:hover {
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
	}
</style>

<script>
	// TypeScript-safe interfaces
	interface Theme {
		key: string;
		label: string;
		tooltip: string;
		nextTooltip: string;
	}

	interface ThemeChangeEvent extends CustomEvent {
		detail: {
			preference: string;
			isDark: boolean;
		};
	}

	interface ThemeManager {
		getPreference(): string;
		setPreference(preference: string): void;
		THEMES: Record<string, string>;
	}

	// Extend Window interface for TypeScript
	declare global {
		interface Window {
			themeManager: ThemeManager;
		}
	}

	class ThemeToggle {
		private button: HTMLElement | null;
		private label: HTMLElement | null;
		private tooltipText: HTMLElement | null;
		private themes: Theme[];
		private currentIndex: number = 0;

		constructor() {
			this.button = document.getElementById("theme-toggle");
			this.label = document.getElementById("theme-label");
			this.tooltipText = document.getElementById("tooltip-text");

			this.themes = [
				{
					key: "light",
					label: "Light",
					tooltip: "Switch to light theme",
					nextTooltip: "Switch to dark theme",
				},
				{
					key: "dark",
					label: "Dark",
					tooltip: "Switch to dark theme",
					nextTooltip: "Switch to system theme",
				},
				{
					key: "system",
					label: "System",
					tooltip: "Switch to system theme",
					nextTooltip: "Switch to light theme",
				},
			];

			this.init();
		}

		private init(): void {
			// Wait for themeManager to be available
			if (typeof window.themeManager === "undefined") {
				setTimeout(() => this.init(), 10);
				return;
			}

			// Set initial state
			const currentPreference = window.themeManager.getPreference();
			this.currentIndex = this.themes.findIndex(
				(theme) => theme.key === currentPreference
			);
			if (this.currentIndex === -1) this.currentIndex = 2; // Default to system

			this.updateDisplay();
			this.bindEvents();
		}

		private bindEvents(): void {
			// Handle button clicks
			if (this.button) {
				this.button.addEventListener("click", () => this.cycleTheme());

				// Handle keyboard navigation
				this.button.addEventListener("keydown", (e: KeyboardEvent) => {
					if (e.key === "Enter" || e.key === " ") {
						e.preventDefault();
						this.cycleTheme();
					}
				});
			}

			// Listen for external theme changes
			window.addEventListener("theme-changed", (e: Event) => {
				const themeEvent = e as ThemeChangeEvent;
				const newIndex = this.themes.findIndex(
					(theme) => theme.key === themeEvent.detail.preference
				);
				if (newIndex !== -1 && newIndex !== this.currentIndex) {
					this.currentIndex = newIndex;
					this.updateDisplay();
				}
			});
		}

		private cycleTheme(): void {
			if (!window.themeManager) return;

			this.currentIndex = (this.currentIndex + 1) % this.themes.length;
			const newTheme = this.themes[this.currentIndex];

			if (newTheme) {
				// Update theme via global manager
				window.themeManager.setPreference(newTheme.key);
				this.updateDisplay();

				// Announce change to screen readers
				this.announceChange(newTheme.label);
			}
		}

		private updateDisplay(): void {
			const currentTheme = this.themes[this.currentIndex];
			const nextTheme =
				this.themes[(this.currentIndex + 1) % this.themes.length];

			if (!currentTheme || !nextTheme) return;

			// Update button data attribute for CSS
			if (this.button) {
				this.button.setAttribute("data-theme", currentTheme.key);

				// Update aria-label for better accessibility
				this.button.setAttribute(
					"aria-label",
					`Current theme: ${currentTheme.label}. Click to switch to ${nextTheme.label}.`
				);
			}

			// Update label text
			if (this.label) {
				this.label.textContent = currentTheme.label;
			}

			// Update tooltip
			if (this.tooltipText) {
				this.tooltipText.textContent = currentTheme.nextTooltip;
			}
		}

		private announceChange(themeName: string): void {
			// Create a temporary element to announce the change to screen readers
			const announcement = document.createElement("div");
			announcement.setAttribute("aria-live", "polite");
			announcement.setAttribute("aria-atomic", "true");
			announcement.className = "sr-only";
			announcement.textContent = `Theme switched to ${themeName}`;

			document.body.appendChild(announcement);

			// Remove after announcement
			setTimeout(() => {
				if (document.body.contains(announcement)) {
					document.body.removeChild(announcement);
				}
			}, 1000);
		}
	}

	// Initialize when DOM is ready
	function initThemeToggle(): void {
		new ThemeToggle();
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initThemeToggle);
	} else {
		initThemeToggle();
	}
</script>
