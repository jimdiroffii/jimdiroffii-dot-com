---
import { Picture } from "astro:assets";
import BaseLayout from "./BaseLayout.astro";
import type { ImageMetadata } from "astro";

interface Frontmatter {
	title: string;
	description?: string;
	pubDate?: Date | string;
	updatedDate?: Date | string;
	author?: string;
	image?: ImageMetadata | string;
	imageAlt?: string;
	tags?: string[];
}

const { frontmatter } = Astro.props as { frontmatter: Frontmatter };

const {
	title,
	description,
	pubDate,
	updatedDate,
	author,
	image,
	imageAlt = "",
	tags = [],
} = frontmatter ?? {};

function displayDate(d?: Date | string): string {
	if (!d) return "";
	const date = typeof d === "string" ? new Date(d) : d;
	return new Intl.DateTimeFormat("en-US", { dateStyle: "long" }).format(date);
}

function iso(d?: Date | string): string | undefined {
	if (!d) return undefined;
	const date = typeof d === "string" ? new Date(d) : d;
	return date.toISOString();
}

const pubISO = iso(pubDate);
const updISO = iso(updatedDate);
---

<BaseLayout pageTitle={title}>
	<article
		class="mx-auto max-w-prose px-5"
		aria-labelledby="page-title"
		itemscope
		itemtype="https://schema.org/BlogPosting"
	>
		<header class="mb-6">
			<p class="mt-2 text-sm opacity-80">
				{
					pubISO && (
						<time datetime={pubISO} itemprop="datePublished">
							{displayDate(pubDate)}
						</time>
					)
				}
				{
					updISO && (
						<>
							{" Â· updated "}
							<time datetime={updISO} itemprop="dateModified">
								{displayDate(updatedDate)}
							</time>
						</>
					)
				}
			</p>

			{
				author && (
					<p class="mt-1">
						By{" "}
						<span class="font-medium" itemprop="author">
							{author}
						</span>
					</p>
				)
			}

			{
				description && (
					<p class="mt-2 italic" itemprop="description">
						{description}
					</p>
				)
			}

			{
				image && (
					<div class="mt-4">
						{typeof image === "string" ? (
							<img
								src={image}
								alt={imageAlt}
								loading="lazy"
								decoding="async"
								width="800"
								class="w-full h-auto rounded-xl"
								itemprop="image"
							/>
						) : (
							<Picture
								src={image}
								alt={imageAlt}
								widths={[320, 640, 960, 1280]}
								sizes="(min-width: 768px) 720px, 100vw"
								loading="lazy"
								decoding="async"
								class="w-full h-auto rounded-xl"
								itemprop="image"
							/>
						)}
					</div>
				)
			}

			{
				Array.isArray(tags) && tags.length > 0 && (
					<nav aria-label="Post tags" class="mt-4">
						<ul class="flex flex-wrap gap-2">
							{tags.map((tag) => (
								<li>
									<a
										href={`/tags/${encodeURIComponent(tag)}`}
										rel="tag"
										class="rounded px-2 py-1 text-sm hover:underline bg-gray-100 dark:bg-gray-800"
									>
										{tag}
									</a>
								</li>
							))}
						</ul>
					</nav>
				)
			}
		</header>

		<div class="prose dark:prose-invert max-w-none" itemprop="articleBody">
			<slot />
		</div>
	</article>
</BaseLayout>
