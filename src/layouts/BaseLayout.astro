---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import type { ImageMetadata } from "astro";
import "../styles/global.css";

type Props = {
	pageTitle: string;
	pageDescription?: string;
	/** Absolute URL string OR ImageMetadata from astro:assets */
	pageImage?: string | ImageMetadata;
	pageImageAlt?: string;
	/** Default "website"; use "article" on posts */
	pageType?: "website" | "article";
};

const {
	pageTitle,
	pageDescription = "Personal portfolio and security blog.",
	pageImage,
	pageImageAlt = "",
	pageType = "website",
} = Astro.props as Props;

const canonical = Astro.site
	? new URL(Astro.url.pathname, Astro.site).toString()
	: undefined;

function absoluteUrl(u?: string): string | undefined {
	if (!u || !Astro.site) return undefined;
	try {
		return new URL(u, Astro.site).toString();
	} catch {
		return undefined;
	}
}

let ogImage: string | undefined;
if (typeof pageImage === "string") {
	ogImage = absoluteUrl(pageImage);
} else if (pageImage?.src) {
	ogImage = Astro.site
		? new URL(pageImage.src, Astro.site).toString()
		: undefined;
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="sitemap" href="/sitemap-index.xml" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />

		<!-- TODO: Remove the robots directive when ready to go live -->
		<meta name="robots" content="noindex, nofollow" />
		<title>{pageTitle}</title>

		{pageDescription && <meta name="description" content={pageDescription} />}
		{canonical && <link rel="canonical" href={canonical} />}

		<!-- Open Graph -->
		<meta property="og:title" content={pageTitle} />
		{
			pageDescription && (
				<meta property="og:description" content={pageDescription} />
			)
		}
		{canonical && <meta property="og:url" content={canonical} />}
		<meta property="og:type" content={pageType} />
		{ogImage && <meta property="og:image" content={ogImage} />}
		{
			ogImage && pageImageAlt && (
				<meta property="og:image:alt" content={pageImageAlt} />
			)
		}

		<!-- Twitter -->
		<meta
			name="twitter:card"
			content={ogImage ? "summary_large_image" : "summary"}
		/>
		<meta name="twitter:title" content={pageTitle} />
		{
			pageDescription && (
				<meta name="twitter:description" content={pageDescription} />
			)
		}
		{ogImage && <meta name="twitter:image" content={ogImage} />}

		<script is:inline>
			// Theme management with system preference support
			const THEME_KEY = "theme-preference";
			const THEMES = {
				LIGHT: "light",
				DARK: "dark",
				SYSTEM: "system",
			};

			// Get the user's theme preference
			function getThemePreference() {
				const stored = localStorage.getItem(THEME_KEY);
				return stored && Object.values(THEMES).includes(stored)
					? stored
					: THEMES.SYSTEM;
			}

			// Determine if dark mode should be active
			function shouldUseDarkMode(preference) {
				switch (preference) {
					case THEMES.DARK:
						return true;
					case THEMES.LIGHT:
						return false;
					case THEMES.SYSTEM:
					default:
						return window.matchMedia("(prefers-color-scheme: dark)").matches;
				}
			}

			// Apply the theme to the document
			function applyTheme(preference) {
				const isDark = shouldUseDarkMode(preference);

				if (isDark) {
					document.documentElement.classList.add("dark");
				} else {
					document.documentElement.classList.remove("dark");
				}

				document.documentElement.style.colorScheme = isDark ? "dark" : "light";

				// Update meta theme-color for mobile browsers
				const metaThemeColor = document.querySelector(
					'meta[name="theme-color"]'
				);
				if (metaThemeColor) {
					metaThemeColor.setAttribute(
						"content",
						isDark ? "#000000" : "#ffffff"
					);
				}

				return isDark;
			}

			// Initialize theme immediately to prevent flash
			const initialPreference = getThemePreference();
			//const initialIsDark = applyTheme(initialPreference);

			// Save the preference if it wasn't explicitly set
			localStorage.setItem(THEME_KEY, initialPreference);

			// Listen for system theme changes
			window
				.matchMedia("(prefers-color-scheme: dark)")
				.addEventListener("change", (e) => {
					const currentPreference = getThemePreference();
					// Only respond to system changes when in system mode
					if (currentPreference === THEMES.SYSTEM) {
						applyTheme(currentPreference);
						// Dispatch custom event for components to listen to
						window.dispatchEvent(
							new CustomEvent("theme-changed", {
								detail: {
									preference: currentPreference,
									isDark: e.matches,
								},
							})
						);
					}
				});

			// Make theme functions available globally for components
			window.themeManager = {
				getPreference: getThemePreference,
				setPreference: (newPreference) => {
					if (!Object.values(THEMES).includes(newPreference)) return;

					localStorage.setItem(THEME_KEY, newPreference);
					const isDark = applyTheme(newPreference);

					// Dispatch event for components
					window.dispatchEvent(
						new CustomEvent("theme-changed", {
							detail: {
								preference: newPreference,
								isDark,
							},
						})
					);
				},
				THEMES,
			};
		</script>

		<!-- Add theme-color meta tag for mobile browsers -->
		<meta name="theme-color" content="#ffffff" />
	</head>
	<body
		class="bg-white dark:bg-black text-black dark:text-white transition-colors duration-200"
	>
		<Header />
		<main>
			<h1 id="page-title" class="font-bold text-4xl m-5">{pageTitle}</h1>
			<slot />
		</main>
		<Footer />
	</body>
</html>
